#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Параметры.Свойство("Место") Тогда
		Место = Параметры.Место;
		// Получаем актуальные данные о месте
		ЗагрузитьДанныеМестаНаСервере();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПриОткрытии(Отказ, СтандартнаяОбработка)
    
    Если Параметры <> Неопределено Тогда
        ЗаполнитьДанныеИзПараметров();
        ОбновитьФормуНаСервере();
    Иначе
        Сообщить("Не переданы параметры для открытия формы!");
    КонецЕсли;
    
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Сохранить(Команда)
    СохранитьНаСервере();
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ЗаполнитьДанныеИзПараметров()
    
    
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьДанныеМестаНаСервере()
    
    Если Место = Неопределено Или Место.Пустая() Тогда
        Возврат;
    КонецЕсли;
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ
    |    Места.Ссылка КАК Место,
    |    Места.Наименование КАК НаименованиеМеста,
    |    Ряда.Ссылка КАК Ряд,
    |    Ряда.Наименование КАК НаименованиеРяда,
    |    Площадка1.Ссылка КАК Площадка,
    |    Площадка1.Наименование КАК НаименованиеПлощадки,
    |    Места.Свободно КАК Свободно,
    |    Места.ТранспортноеСредство КАК ТранспортноеСредство
    |ИЗ
    |    Справочник.Места КАК Места
    |        ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Ряда КАК Ряда
    |        ПО Места.Владелец = Ряда.Ссылка
    |            ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Площадка КАК Площадка1
    |            ПО Ряда.Владелец = Площадка1.Ссылка
    |ГДЕ
    |    Места.Ссылка = &Место
    |    И НЕ Места.ПометкаУдаления
    |    И (Ряда.Ссылка = ЗНАЧЕНИЕ(Справочник.Ряда.ПустаяСсылка) ИЛИ НЕ Ряда.ПометкаУдаления)";
    
    Запрос.УстановитьПараметр("Место", Место);
    
    Попытка
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        Если Выборка.Следующий() Тогда
            // Заполняем данные из запроса
            Место = Выборка.Место;
            Ряд = Выборка.Ряд;
            Площадка = Выборка.Площадка;
            Свободно = Выборка.Свободно;
            ТранспортноеСредство = Выборка.ТранспортноеСредство;
        Иначе
            Сообщить("Не удалось найти данные о месте!");
        КонецЕсли;
        
    Исключение
        Сообщить("Ошибка при загрузке данных места: " + ОписаниеОшибки());
    КонецПопытки;
    
КонецПроцедуры

&НаСервере
Процедура ОбновитьФормуНаСервере()
    ОбновитьФорму();
КонецПроцедуры

&НаСервере
Процедура ОбновитьФорму()
    
    Если Место = Неопределено Или Место.Путь() Тогда
        Сообщить("Место не указано!");
        Возврат;
    КонецЕсли;
    
    Попытка
        // Заполняем информацию о месте
        Элементы.НадписьПлощадка.Заголовок = "Площадка: " + Площадка.Наименование;
        Элементы.НадписьРяд.Заголовок = "Ряд: " + Ряд.Наименование;
        Элементы.НадписьМесто.Заголовок = "Место: " + Место.Наименование;
        
        // Обновляем статус места
        Если Свободно Тогда
            Элементы.НадписьСтатус.Заголовок = "Статус: СВОБОДНО";
            Элементы.НадписьСтатус.ЦветТекста = Новый Цвет(0, 128, 0); // Зеленый
            Элементы.ПолеТранспортноеСредство.Видимость = Истина;
            Элементы.НадписьТекущееТС.Заголовок = "Транспортное средство не выбрано";
        Иначе
            Элементы.НадписьСтатус.Заголовок = "Статус: ЗАНЯТО";
            Элементы.НадписьСтатус.ЦветТекста = Новый Цвет(255, 0, 0); // Красный
            Элементы.ПолеТранспортноеСредство.Видимость = Ложь;
            
            // Показываем информацию о транспортном средстве
            Если ТранспортноеСредство = Неопределено Или ТранспортноеСредство.Пустая() Тогда
                Элементы.НадписьТекущееТС.Заголовок = "Транспортное средство: Не указано";
            Иначе
                Элементы.НадписьТекущееТС.Заголовок = "Транспортное средство: " + ТранспортноеСредство.Наименование;
            КонецЕсли;
        КонецЕсли;
        
    Исключение
        Сообщить("Ошибка при обновлении формы: " + ОписаниеОшибки());
    КонецПопытки;
    
КонецПроцедуры

&НаСервере
Процедура СохранитьНаСервере()
    
    Попытка
        // Пробуем обновить данные в базе
        ОбновитьДанныеВБазе();
        
        // Сообщаем об успешном сохранении
        Сообщить("Изменения сохранены успешно!");
        
        // Закрываем форму с результатом
        Закрыть(Истина);
        
    Исключение
        Сообщить("Ошибка при сохранении изменений: " + ОписаниеОшибки());
    КонецПопытки;
    
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписиРезультата(УспешноеСохранение, ДополнительныеПараметры) Экспорт
    
    Если УспешноеСохранение Тогда
        Закрыть(Истина);
    КонецЕсли;
    
КонецПроцедуры

&НаСервере
Процедура ОбновитьДанныеВБазе()
    
    Если Место = Неопределено Или Место.Пустая() Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        // Находим объект места
        ОбъектМеста = Место.ПолучитьОбъект();
        
        // Безопасная установка реквизитов
        Попытка
            ОбъектМеста.Свободно = Свободно;
        Исключение
            // Реквизит "Свободно" не существует - продолжаем работу
        КонецПопытки;
        
        Попытка
            ОбъектМеста.ТранспортноеСредство = ТранспортноеСредство;
        Исключение
            // Реквизит "ТранспортноеСредство" не существует - продолжаем работу
        КонецПопытки;
        
        // Сохраняем изменения
        ОбъектМеста.Записать();
        
    Исключение
        Сообщить("Ошибка при обновлении данных в базе: " + ОписаниеОшибки());
        ВызватьИсключение;
    КонецПопытки;
    
КонецПроцедуры

&НаКлиенте
Процедура ПриИзмененииТранспортноеСредство(Элемент)
    
    // Обновляем отображение выбранного транспортного средства
    Если ТранспортноеСредство = Неопределено Или ТранспортноеСредство.Пустая() Тогда
        Элементы.НадписьТекущееТС.Заголовок = "Транспортное средство не выбрано";
    Иначе
        Элементы.НадписьТекущееТС.Заголовок = "Транспортное средство: " + ТранспортноеСредство.Наименование;
    КонецЕсли;
    
КонецПроцедуры

#КонецОбласти