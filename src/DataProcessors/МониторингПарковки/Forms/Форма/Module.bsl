#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

	// Инициализация при создании формы
	ОбновитьМеста();

КонецПроцедуры 

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	// Вставить содержимое обработчика.
КонецПроцедуры

// ++ хрень 
&НаСервере
Процедура ПриОткрытииНаСервере(Отказ, СтандартнаяОбработка)
    //ОбновитьТаблицуМестНаСервере();
    //ОбновитьПарковкуНаСервере();
КонецПроцедуры
// -- хрень 

// ++ хрень 
&НаКлиенте
Процедура ПриЗакрытии(РезультатЗакрытия, ДополнительныеПараметры)
    
	// ++ хрень 
	Если РезультатЗакрытия = Истина Тогда
        // Если форма ячейки закрылась с результатом (после сохранения)
        // Обновляем данные на основной форме
        //ОбновитьТаблицуМестНаСервере();
        //ОбновитьПарковкуНаСервере();
        //Сообщить("Данные обновлены!");
    КонецЕсли;
    // -- хрень 
	
КонецПроцедуры
// -- хрень 

#КонецОбласти


#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ОбновитьТаблицуМест(Команда)
	ОбновитьМеста();
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьКликЯчейки(Команда)
	ОткрытьФормуЯчейки(Команда);
КонецПроцедуры

#КонецОбласти 

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ОбновитьМеста()
	ОбновитьЭлементыМест();
КонецПроцедуры

&НаСервере
Функция ВыборкаМест()

	ТаблицаМест.Очистить();
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Места.Ссылка КАК Место,
	|	Места.Наименование КАК НаименованиеМеста,
	|	Ряда.Ссылка КАК Ряд,
	|	Ряда.Наименование КАК НаименованиеРяда,
	|	Площадка1.Ссылка КАК Площадка,
	|	Площадка1.Наименование КАК НаименованиеПлощадки,
	|	Истина КАК Свободно,
	|	ЗНАЧЕНИЕ(Справочник.ТранспортныеСредства.ПустаяСсылка) КАК ТранспортноеСредство
	|ИЗ
	|	Справочник.Площадка КАК Площадка1
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Ряда КАК Ряда
	|		ПО Площадка1.Ссылка = Ряда.Владелец
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Места КАК Места
	|		ПО (Ряда.Ссылка = Места.Владелец)
	|ГДЕ
	|	НЕ Ряда.ПометкаУдаления
	|	И НЕ Места.ПометкаУдаления
	|
	|УПОРЯДОЧИТЬ ПО
	|	Площадка,
	|	Ряд,
	|	Место
	|ИТОГИ ПО
	|	Площадка,
	|	Ряд";
	
		
	Возврат Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		
КонецФункции

&НаСервере
Процедура ОбновитьЭлементыМест()
	
	ТаблицаМест.Очистить();
	
	ГруппаСетка = Элементы.Добавить("ГруппаСетка", Тип("ГруппаФормы"), ЭтаФорма);
	ГруппаСетка.Вид = ВидГруппыФормы.ОбычнаяГруппа;
	ГруппаСетка.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
	
	ВыборкаПлощадки = ВыборкаМест();
	
	Пока ВыборкаПлощадки.Следующий() Цикл
		ВыборкаРяды = ВыборкаПлощадки.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		
		ИмяПлощадки = СтрЗаменитьПоРегулярномуВыражению(ВыборкаПлощадки.НаименованиеПлощадки,"[^a-zA-Z0-9а-яА-ЯёЁ]","_");
		ГруппаПлощадка = Элементы.Добавить("ГруппаПлощадка_" + ИмяПлощадки, Тип("ГруппаФормы"), ГруппаСетка);
		ГруппаПлощадка.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		ГруппаПлощадка.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
		ГруппаПлощадка.Заголовок = "Площадка: " + ВыборкаПлощадки.НаименованиеПлощадки;
		
		Пока ВыборкаРяды.Следующий() Цикл
			ВыборкаМеста = ВыборкаРяды.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			
			ИмяРяда = СтрЗаменитьПоРегулярномуВыражению(ВыборкаРяды.НаименованиеРяда,"[^a-zA-Z0-9а-яА-ЯёЁ]","_");
			ИмяГруппы = "ГруппаРяд_" + ИмяПлощадки + "_" + ИмяРяда;
			ГруппаРяд = Элементы.Добавить(ИмяГруппы, Тип("ГруппаФормы"), ГруппаПлощадка);
			ГруппаРяд.Вид = ВидГруппыФормы.ОбычнаяГруппа;
			ГруппаРяд.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Горизонтальная;
			ГруппаРяд.Заголовок = "Ряд: " + ВыборкаРяды.НаименованиеПлощадки;
			
			Пока ВыборкаМеста.Следующий() Цикл
				Строка = ТаблицаМест.Добавить();
				ЗаполнитьЗначенияСвойств(Строка, ВыборкаМеста);
				Индекс = ТаблицаМест.Индекс(Строка);
				
				ГруппаМесто = Элементы.Добавить("Место_" + Индекс, Тип("ГруппаФормы"), ГруппаРяд);
				ГруппаМесто.Вид = ВидГруппыФормы.ОбычнаяГруппа;
				
				
				Если Строка.Свободно Тогда
					ГруппаМесто.ЦветФона = Новый Цвет(0, 255, 127); // Зеленый - свободно
					ТекстАвто = "Свободно";
				Иначе
					ГруппаМесто.ЦветФона = Новый Цвет(255, 128, 114); // Красный - занято
					Если Строка.ТранспортноеСредство = Неопределено Или Строка.ТранспортноеСредство.Пустая() Тогда
						ТекстАвто = "Машина";
					Иначе
						ТекстАвто = Строка.ТранспортноеСредство.Наименование;
					КонецЕсли;
				КонецЕсли;

				КомандаМесто = Команды.Добавить("КомандаМесто_" + Индекс);
				КомандаМесто.Действие = "ОткрытьФормуМеста";
				КомандаМесто.Заголовок = ?(Строка.Свободно,"Забронировать","Освободить");

				КнопкаМесто = Элементы.Добавить("КнопкаЯчейка_" + Индекс, Тип("КнопкаФормы"), ГруппаМесто);
				КнопкаМесто.ИмяКоманды = КомандаМесто.Имя;
				КнопкаМесто.Ширина = 18;
				КнопкаМесто.Высота = 2;
				
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;

	
	
	
	//УдалитьДинамическиеЭлементы();
	//
	
	// ++ хрень
	//Если ТаблицаМест.Количество() = 0 Тогда
	//    Сообщить("Нет данных о местах!");
	//    Возврат;
	//КонецЕсли;
	// -- хрень
	//
	//ГруппаСетка = Элементы.Добавить("ГруппаСетка", Тип("ГруппаФормы"), ЭтаФорма);
	//ГруппаСетка.Вид = ВидГруппыФормы.ОбычнаяГруппа;
	//ГруппаСетка.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
	//
	//ЭтотОбъект.ТаблицаМест.Сортировать("Площадка,Ряд,Место");
	//
	//Для Каждого 
	
	
	////ДанныеПарковки = СгруппироватьМестаПоПлощадкамИРядам();
	//
	//НомерПлощадки = 0;
	//Для Каждого ПлощадкаИзКоллекции Из ДанныеПарковки Цикл
	//    Площадка = ПлощадкаИзКоллекции.Ключ;
	//    РядыПлощадки = ПлощадкаИзКоллекции.Значение;
	//    НомерПлощадки = НомерПлощадки + 1;
	//    
	//    ГруппаПлощадка = Элементы.Добавить("ГруппаПлощадка_" + НомерПлощадки, Тип("ГруппаФормы"), ГруппаСетка);
	//    ГруппаПлощадка.Вид = ВидГруппыФормы.ОбычнаяГруппа;
	//    ГруппаПлощадка.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
	//    ГруппаПлощадка.Заголовок = "Площадка: " + Площадка.Наименование;
	//    
	//    МассивРядов = Новый Массив;
	//    Для Каждого РядИзКоллекции Из РядыПлощадки Цикл
	//        МассивРядов.Вставить(0, РядИзКоллекции); // Вставляем в начало массива
	//    КонецЦикла;
	//	
	//	НомерРяда = 0;
	//    Для i = 0 По МассивРядов.ВГраница() Цикл
	//        РядИзКоллекции = МассивРядов[i];
	//        Ряд = РядИзКоллекции.Ключ;
	//        МестаРяда = РядИзКоллекции.Значение;
	//        НомерРяда = НомерРяда + 1;
	//        
	//        СоздатьРядПарковки(НомерПлощадки, НомерРяда, Площадка, Ряд, МестаРяда);
	//    КонецЦикла;
	//    
	//КонецЦикла;
    
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьФормуМеста(Команда)
	
	Индекс = Число(СтрЗаменить(Команда.Имя,"КомандаМесто_", ""));
	Строка = ТаблицаМест[Индекс];
	ПараметрыФормы = Новый Структура("Место,Ряд,Площадка,Свободно,ТранспортноеСредство");
	ЗаполнитьЗначенияСвойств(ПараметрыФормы,Строка);
	ПараметрыОткрытия = Новый Структура("ЗначенияЗаполнения",ПараметрыФормы);
	ОткрытьФорму("Документ.ВъездНаПарковку.Форма.ФормаДокумента",ПараметрыОткрытия);
	
	//ОткрытьФорму("Обработка.МониторингПарковки.Форма.ФормаЯчейки", ПараметрыФормы, ЭтаФорма, , , , , РежимОткрытияОкнаФормы.БлокироватьВесьИнтерфейс);
	
КонецПроцедуры

// ++ хрень
&НаСервере
Функция СгруппироватьМестаПоПлощадкамИРядам()

	Данные = Новый Соответствие;
	
	Для Каждого СтрокаМеста Из ТаблицаМест Цикл
		
		Площадка = СтрокаМеста.Площадка;
		
		Если Данные[Площадка] = Неопределено Тогда
			Данные.Вставить(Площадка, Новый Соответствие);
		КонецЕсли;
	
		Ряд = СтрокаМеста.Ряд;
		Если Данные[Площадка][Ряд] = Неопределено Тогда
			Данные[Площадка].Вставить(Ряд, Новый Массив);
		КонецЕсли;
		
		Если Данные[Площадка][Ряд].Найти(СтрокаМеста.Место) = Неопределено Тогда
			Данные[Площадка][Ряд].Добавить(СтрокаМеста);
		КонецЕсли;
		
	КонецЦикла;

	Возврат Данные;

КонецФункции
// -- хрень

// ++ удалить
&НаСервере
Процедура СоздатьРядПарковки(НомерПлощадки, НомерРяда, Площадка, Ряд, МестаРяда)
    
    Попытка
        ИмяГруппы = "ГруппаРяд_" + НомерПлощадки + "_" + НомерРяда;
        ГруппаРяд = Элементы.Добавить(ИмяГруппы, Тип("ГруппаФормы"), Элементы["ГруппаПлощадка_" + НомерПлощадки]);
        ГруппаРяд.Вид = ВидГруппыФормы.ОбычнаяГруппа;
        ГруппаРяд.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Горизонтальная;
        ГруппаРяд.Заголовок = "Ряд: " + Ряд.Наименование;
        
        НомерМеста = 0;
        Для Каждого СтрокаМеста Из МестаРяда Цикл
            НомерМеста = НомерМеста + 1;
            СоздатьЯчейкуПарковки(НомерПлощадки, НомерРяда, НомерМеста, Площадка, Ряд, СтрокаМеста);
        КонецЦикла;
        
    Исключение
        Сообщить("Ошибка при создании ряда " + Ряд.Наименование + ": " + ОписаниеОшибки());
    КонецПопытки;
    
КонецПроцедуры

&НаСервере
Процедура СоздатьЯчейкуПарковки(НомерПлощадки, НомерРяда, НомерМеста, Площадка, Ряд, СтрокаМеста)
    
    Попытка
        Место = СтрокаМеста.Место;
        ИмяГруппы = "Ячейка_" + НомерПлощадки + "_" + НомерРяда + "_" + НомерМеста;
        
        ИмяГруппыРяда = "ГруппаРяд_" + НомерПлощадки + "_" + НомерРяда;
        ГруппаРодитель = Элементы[ИмяГруппыРяда];
        
        ГруппаЯчейка = Элементы.Добавить(ИмяГруппы, Тип("ГруппаФормы"), ГруппаРодитель);
        ГруппаЯчейка.Вид = ВидГруппыФормы.ОбычнаяГруппа;
        ГруппаЯчейка.Ширина = 18;
        ГруппаЯчейка.Высота = 2;
        
        // ============ ИСПОЛЬЗУЕМ РЕАЛЬНЫЕ ДАННЫЕ ИЗ БАЗЫ ============
        Если СтрокаМеста.Свободно Тогда
            ГруппаЯчейка.ЦветФона = Новый Цвет(0, 255, 127); // Зеленый - свободно
            ТекстАвто = "Свободно";
        Иначе
            ГруппаЯчейка.ЦветФона = Новый Цвет(255, 128, 114); // Красный - занято
            Если СтрокаМеста.ТранспортноеСредство = Неопределено Или СтрокаМеста.ТранспортноеСредство.Пустая() Тогда
                ТекстАвто = "Машина";
            Иначе
                ТекстАвто = СтрокаМеста.ТранспортноеСредство.Наименование;
            КонецЕсли;
        КонецЕсли;

        НадписьАвто = Элементы.Добавить("Авто_" + ИмяГруппы, Тип("ДекорацияФормы"), ГруппаЯчейка);
        НадписьАвто.Вид = ВидДекорацииФормы.Надпись;
        НадписьАвто.Заголовок = ТекстАвто; 
        НадписьАвто.Ширина = 18;
        НадписьАвто.Высота = 1;
        НадписьАвто.ГоризонтальноеПоложение = ГоризонтальноеПоложениеЭлемента.Центр;
        НадписьАвто.ВертикальноеПоложение = ВертикальноеПоложениеЭлемента.Верх;
          
        НадписьМесто = Элементы.Добавить("Место_" + ИмяГруппы, Тип("ДекорацияФормы"), ГруппаЯчейка);
        НадписьМесто.Вид = ВидДекорацииФормы.Надпись;
        НадписьМесто.Заголовок = Ряд.Наименование + " " + Место.Наименование;  
        НадписьМесто.Ширина = 18;
        НадписьМесто.Высота = 1;
        НадписьМесто.ГоризонтальноеПоложение = ГоризонтальноеПоложениеЭлемента.Центр;
        НадписьМесто.ВертикальноеПоложение = ВертикальноеПоложениеЭлемента.Низ;
        
        // ============ ДОБАВЛЕНИЕ КЛИКАБЕЛЬНОЙ КНОПКИ НА ВСЮ ЯЧЕЙКУ ============
        
        // Создаем команду для клика по ячейке
        ИмяКоманды = "КомандаЯчейки_" + НомерПлощадки + "_" + НомерРяда + "_" + НомерМеста;
        Команда = Команды.Добавить(ИмяКоманды);
        Команда.Действие = "ОбработатьКликЯчейки";
        Команда.Заголовок = "Открыть форму для места " + Ряд.Наименование + " " + Место.Наименование;
        
        // Создаем невидимую кнопку на всю ячейку для обработки клика
        КнопкаЯчейка = Элементы.Добавить("КнопкаЯчейка_" + ИмяГруппы, Тип("КнопкаФормы"), ГруппаЯчейка);
        КнопкаЯчейка.ИмяКоманды = ИмяКоманды;
        КнопкаЯчейка.Ширина = 18;
        КнопкаЯчейка.Высота = 2;
        КнопкаЯчейка.Заголовок = "";
        
    Исключение
        Сообщить("Ошибка при создании ячейки " + Место.Наименование + ": " + ОписаниеОшибки());
    КонецПопытки;
    
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьФормуЯчейки(Команда)
    
    Попытка
        // Получаем идентификаторы из имени команды
        ИмяКоманды = Команда.Имя;
        
        // Формат: КомандаЯчейки_{НомерПлощадки}_{НомерРяда}_{НомерМеста}
        ЧастиИмени = СтрРазделить(ИмяКоманды, "_");
        
        Если ЧастиИмени.Количество() = 4 Тогда
            НомерПлощадки = Число(ЧастиИмени[1]);
            НомерРяда = Число(ЧастиИмени[2]);
            НомерМеста = Число(ЧастиИмени[3]);
            
            // Находим соответствующую строку в таблице
            СтрокаМеста = НайтиСтрокуМеста(НомерПлощадки, НомерРяда, НомерМеста);
            
            Если СтрокаМеста <> Неопределено Тогда
                // Открываем форму ячейки и передаем данные о месте
                ПараметрыФормы = Новый Структура;
                ПараметрыФормы.Вставить("Место", СтрокаМеста.Место);
                ПараметрыФормы.Вставить("Ряд", СтрокаМеста.Ряд);
                ПараметрыФормы.Вставить("Площадка", СтрокаМеста.Площадка);
                ПараметрыФормы.Вставить("Свободно", СтрокаМеста.Свободно);
                ПараметрыФормы.Вставить("ТранспортноеСредство", СтрокаМеста.ТранспортноеСредство);
                // Владелец не передаем - это вызывает ошибку
                
                ОткрытьФорму("Обработка.МониторингПарковки.Форма.ФормаЯчейки", ПараметрыФормы, ЭтаФорма, , , , , РежимОткрытияОкнаФормы.БлокироватьВесьИнтерфейс);
                
            Иначе
                Сообщить("Место не найдено!");
            КонецЕсли;
        Иначе
            Сообщить("Неизвестный формат имени команды: " + ИмяКоманды);
        КонецЕсли;
        
    Исключение
        Сообщить("Ошибка при открытии формы ячейки: " + ОписаниеОшибки());
    КонецПопытки;
    
КонецПроцедуры
// -- удалить

// ++ удалить
&НаКлиенте
Функция НайтиСтрокуМеста(НомерПлощадки, НомерРяда, НомерМеста)
    
    Попытка
        // Создаем структуру для группировки данных на клиенте
        ДанныеПарковки = Новый Соответствие;
        
        // Группируем места по площадкам и рядам
        Для Каждого СтрокаМеста Из ТаблицаМест Цикл
            Площадка = СтрокаМеста.Площадка;
            Ряд = СтрокаМеста.Ряд;
            
            Если Не ДанныеПарковки[Площадка] <> Неопределено Тогда
                ДанныеПарковки[Площадка] = Новый Соответствие;
            КонецЕсли;
            
            РядыПлощадки = ДанныеПарковки[Площадка];
            
            Если Не РядыПлощадки[Ряд] <> Неопределено Тогда
                РядыПлощадки[Ряд] = Новый Массив;
            КонецЕсли;
            
            МестаРяда = РядыПлощадки[Ряд];
            МестаРяда.Добавить(СтрокаМеста);
        КонецЦикла;
        
        // Ищем нужную площадку
        НомерТекущейПлощадки = 0;
        Для Каждого ПлощадкаИзКоллекции Из ДанныеПарковки Цикл
            НомерТекущейПлощадки = НомерТекущейПлощадки + 1;
            
            Если НомерТекущейПлощадки = НомерПлощадки Тогда
                РядыПлощадки = ПлощадкаИзКоллекции.Значение;
                
                // Создаем массив рядов для правильного порядка (как при отрисовке)
                МассивРядов = Новый Массив;
                Для Каждого РядИзКоллекции Из РядыПлощадки Цикл
                    МассивРядов.Вставить(0, РядИзКоллекции);
                КонецЦикла;
                
                // Ищем нужный ряд
                НомерТекущегоРяда = 0;
                Для i = 0 По МассивРядов.ВГраница() Цикл
                    НомерТекущегоРяда = НомерТекущегоРяда + 1;
                    
                    Если НомерТекущегоРяда = НомерРяда Тогда
                        РядИзКоллекции = МассивРядов[i];
                        МестаРяда = РядИзКоллекции.Значение;
                        
                        // Ищем нужное место
                        Если НомерМеста <= МестаРяда.Количество() Тогда
                            Возврат МестаРяда[НомерМеста - 1];
                        Иначе
                            Сообщить("Место " + НомерМеста + " не найдено в ряду " + НомерРяда);
                            Возврат Неопределено;
                        КонецЕсли;
                    КонецЕсли;
                КонецЦикла;
                
                Сообщить("Ряд " + НомерРяда + " не найден на площадке " + НомерПлощадки);
                Возврат Неопределено;
            КонецЕсли;
        КонецЦикла;
        
        Сообщить("Площадка " + НомерПлощадки + " не найдена");
        Возврат Неопределено;
        
    Исключение
        Сообщить("Ошибка при поиске места: " + ОписаниеОшибки());
        Возврат Неопределено;
    КонецПопытки;
    
КонецФункции
// -- удалить

// ++ хрень
&НаСервере
Процедура УдалитьДинамическиеЭлементы()
    
    ИменаКомандДляУдаления = Новый Массив;
    Для Каждого Команда Из Команды Цикл
        Если Лев(Команда.Имя, 14) = "КомандаЯчейки_" Тогда
            Команды.Удалить(Команда);
        КонецЕсли;
    КонецЦикла;

	ИменаЭлементовДляУдаления = Новый Массив;
	Для Каждого Элемент Из Элементы Цикл
		Если Лев(Элемент.Имя, 7) = "Ячейка_" 
			Или Лев(Элемент.Имя, 11) = "ГруппаРяд_" 
			Или Лев(Элемент.Имя, 16) = "ГруппаПлощадка_"
			Или Лев(Элемент.Имя, 13) = "КнопкаЯчейка"
			Или Лев(Элемент.Имя, 5) = "Авто_"
			Или Лев(Элемент.Имя, 6) = "Место_"
			Или Элемент.Имя = "ГруппаСетка"
		Тогда
			Элементы.Удалить(Элемент);
		КонецЕсли;
	КонецЦикла;

КонецПроцедуры
// -- хрень


#КонецОбласти